name: Auto Create PR

on:
  push:
    branches-ignore:
      - main
      - gh-pages

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to compare with main

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          # Check if PR exists for this branch
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number // empty')

          if [ -n "$PR_NUMBER" ]; then
            echo "PR #$PR_NUMBER already exists for branch $BRANCH_NAME"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "No PR exists for branch $BRANCH_NAME"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR title from branch name
        if: steps.check_pr.outputs.skip == 'false'
        id: generate_title
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          # Remove special characters and convert to lowercase
          CLEAN_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[_\/-]/ /g')

          # Determine semantic prefix based on branch name pattern
          if [[ "$BRANCH_NAME" == feature/* ]]; then
            PREFIX="feat"
            TITLE_BODY="${CLEAN_NAME#feature }"
          elif [[ "$BRANCH_NAME" == fix/* ]] || [[ "$BRANCH_NAME" == fixes/* ]]; then
            PREFIX="fix"
            # Remove either 'fix ' or 'fixes ' from the title
            if [[ "$BRANCH_NAME" == fixes/* ]]; then
              TITLE_BODY="${CLEAN_NAME#fixes }"
            else
              TITLE_BODY="${CLEAN_NAME#fix }"
            fi
          elif [[ "$BRANCH_NAME" == docs/* ]]; then
            PREFIX="docs"
            TITLE_BODY="${CLEAN_NAME#docs }"
          elif [[ "$BRANCH_NAME" == style/* ]]; then
            PREFIX="style"
            TITLE_BODY="${CLEAN_NAME#style }"
          elif [[ "$BRANCH_NAME" == refactor/* ]]; then
            PREFIX="refactor"
            TITLE_BODY="${CLEAN_NAME#refactor }"
          elif [[ "$BRANCH_NAME" == perf/* ]]; then
            PREFIX="perf"
            TITLE_BODY="${CLEAN_NAME#perf }"
          elif [[ "$BRANCH_NAME" == test/* ]]; then
            PREFIX="test"
            TITLE_BODY="${CLEAN_NAME#test }"
          elif [[ "$BRANCH_NAME" == build/* ]]; then
            PREFIX="build"
            TITLE_BODY="${CLEAN_NAME#build }"
          elif [[ "$BRANCH_NAME" == ci/* ]]; then
            PREFIX="ci"
            TITLE_BODY="${CLEAN_NAME#ci }"
          elif [[ "$BRANCH_NAME" == chore/* ]] || [[ "$BRANCH_NAME" == chores/* ]]; then
            PREFIX="chore"
            # Remove either 'chore ' or 'chores ' from the title
            if [[ "$BRANCH_NAME" == chores/* ]]; then
              TITLE_BODY="${CLEAN_NAME#chores }"
            else
              TITLE_BODY="${CLEAN_NAME#chore }"
            fi
          else
            # Default to feat for other branch patterns
            PREFIX="feat"
            TITLE_BODY="$CLEAN_NAME"
          fi

          # Create semantic title
          PR_TITLE="${PREFIX}: ${TITLE_BODY}"

          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "Generated PR title: $PR_TITLE"

      - name: Generate PR body
        if: steps.check_pr.outputs.skip == 'false'
        id: generate_body
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"

          # Get commit messages since branching from main
          COMMITS=$(git log --oneline origin/main..HEAD --pretty=format:"- %s" || echo "- Initial commit")

          # Create PR body using template format with direct variable substitution
          cat > pr_body.md << EOF
          ## Description

          This PR was automatically created from the \`${BRANCH_NAME}\` branch.

          ### Commits in this PR:
          ${COMMITS}

          ## Type of Change

          - [ ] Bug fix (non-breaking change which fixes an issue)
          - [ ] New feature (non-breaking change which adds functionality)
          - [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)
          - [ ] Documentation update
          - [ ] Code refactoring
          - [ ] Performance improvement
          - [ ] Test additions or improvements
          - [ ] Build/CI configuration changes

          ## Testing

          - [ ] I have tested these changes locally
          - [ ] I have added tests that prove my fix is effective or that my feature works
          - [ ] New and existing unit tests pass locally with my changes
          - [ ] I have checked the code coverage report

          ## Checklist

          - [ ] My code follows the style guidelines of this project
          - [ ] I have performed a self-review of my own code
          - [ ] I have commented my code, particularly in hard-to-understand areas
          - [ ] I have made corresponding changes to the documentation
          - [ ] My changes generate no new warnings
          - [ ] Any dependent changes have been merged and published

          ---

          *Automatically created by [Auto PR Workflow](https://github.com/${REPO}/actions/runs/${RUN_ID})*
          EOF

          echo "PR body generated successfully"

      - name: Create Pull Request
        if: steps.check_pr.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_TITLE="${{ steps.generate_title.outputs.title }}"

          # Create PR with gh CLI
          gh pr create \
            --title "$PR_TITLE" \
            --body-file pr_body.md \
            --base main \
            --head "${{ github.ref_name }}"

          echo "âœ… Pull request created successfully!"
